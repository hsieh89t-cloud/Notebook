<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1" />
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.json" />
  <title>Notebook（v1.0.7d 完整）</title>
  <style>
    :root { --bg:#111; --fg:#fff; --muted:#9aa0a6; --card:#1a1a1a; --border:#232323; --danger:#ff9b9b; --ok:#8fd98f; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family: -apple-system,BlinkMacSystemFont,'PingFang TC','Noto Sans TC',system-ui,sans-serif; height:100%; }
    body { touch-action: manipulation; }
    header { position:sticky; top:0; z-index:10; background:var(--bg); padding:10px 10px 6px; border-bottom:1px solid var(--border); }
    .row { display:flex; gap:8px; align-items:center; }
    input, textarea { width:100%; background:#000; color:var(--fg); border:1px solid #333; padding:12px 14px; border-radius:12px; }
    input::placeholder, textarea::placeholder { color:#555; }
    /* 按鈕點擊感 */
    button { position:relative; overflow:hidden; background:#222; color:var(--fg); border:1px solid #333; padding:10px 12px; border-radius:12px; font-weight:600; transition:transform .06s ease; }
    button:active { transform: scale(0.97); }
    .ripple { position:absolute; border-radius:50%; width:8px; height:8px; transform: translate(-50%,-50%); pointer-events:none; animation:ripple .5s ease-out; background:rgba(255,255,255,.25); }
    @keyframes ripple { from { opacity:1; width:0; height:0; } to { opacity:0; width:200px; height:200px; } }
    main { padding:10px 8px 22vh; }
    .note { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin:10px 4px; display:flex; gap:10px; }
    .note-body { flex:1; min-width:0; }
    .title { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; font-weight:700; font-size:16px; line-height:1.25; }
    .meta { color:var(--muted); font-size:12px; margin-top:4px; display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; }
    .actions { display:flex; flex-direction:column; gap:6px; }
    .empty { color:var(--muted); text-align:center; margin-top:18px; }
    .fab { position:fixed; right:16px; bottom:16px; background:#2a2a2a; border:1px solid #333; border-radius:16px; padding:12px 14px; box-shadow: 0 6px 18px rgba(0,0,0,.35); }
    .fab span { font-size:14px; }
    dialog { width:min(680px, 94vw); background:var(--card); color:var(--fg); border:1px solid #333; border-radius:14px; padding:0; }
    dialog::backdrop { background:rgba(0,0,0,.6); }
    .dlg-head { padding:12px 14px; border-bottom:1px solid #333; font-weight:700; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .dlg-body { padding:14px; display:flex; flex-direction:column; gap:10px; }
    .dlg-foot { display:flex; gap:8px; justify-content:flex-end; padding:10px 14px; border-top:1px solid #333; }
    .chip { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #333; color:#9aa0a6; }
    .read-title { font-weight:800; font-size:18px; line-height:1.35; word-break:break-word; }
    .read-meta { color:var(--muted); font-size:12px; }
    .read-content { white-space:pre-wrap; word-break:break-word; line-height:1.6; }
    .read-nav { display:flex; justify-content:space-between; gap:8px; }
    .tip { color:#9aa0a6; font-size:12px; }
    .err { color:var(--danger); font-size:12px; white-space:pre-wrap; word-break:break-word; padding:0 12px; }
    .ok { color:var(--ok); font-size:12px; white-space:pre-wrap; word-break:break-word; padding:0 12px; }
    .status { font-size:12px; color:#9aa0a6; min-height:1.2em; }
    .status.ok { color:var(--ok); }
    .status.err { color:var(--danger); }
    .toast { position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#2a2a2a; border:1px solid #333; padding:10px 14px; border-radius:999px; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s; }
    .toast.show { opacity:1; transform:translateX(-50%) translateY(-4px); }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div style="font-weight:800">Notebook</div>
      <span class="chip">左緣→右滑：上一頁</span>
      <span class="chip" id="count">0 筆</span>
      <button id="btnRefresh" style="margin-left:auto">更新</button>
    </div>
    <div class="row" style="margin-top:6px">
      <input id="q" placeholder="搜尋標題或內容…" />
      <button id="btnSearch">搜尋</button>
      <button id="btnClear">清空</button>
    </div>
  </header>

  <main id="list"></main>
  <div id="error" class="err"></div>

  <button class="fab" id="btnNew"><span>＋ 新增</span></button>

  <!-- 單框輸入（新增） -->
  <dialog id="dlgNew">
    <div class="dlg-head">新增（單框輸入）</div>
    <div class="dlg-body">
      <textarea id="fOne" rows="10" placeholder="直接貼上或輸入：
標題：我今天的想法
分類：日記
#靈感 #工作
這裡是內容…（沒有填的就略過）"></textarea>
      <div class="tip">規則：有「標題：」就取後面；有「分類：」就取後面；有「#標籤」就全部撿起來；其餘文字當作內容。日期會自動帶入台北時間。</div>
      <div id="statusNew" class="status"></div>
    </div>
    <div class="dlg-foot">
      <button id="btnCancelNew">關閉</button>
      <button id="btnSaveNew">儲存</button>
    </div>
  </dialog>

  <!-- 編輯視窗 -->
  <dialog id="dlgEdit">
    <div class="dlg-head" id="dlgTitle">編輯筆記</div>
    <div class="dlg-body">
      <input id="fTitle" placeholder="標題" />
      <textarea id="fContent" rows="8" placeholder="內容"></textarea>
      <input id="fCategory" placeholder="分類" />
      <input id="fTags" placeholder="標籤（以逗號分隔）" />
      <input id="fDate" placeholder="日期（自動）" disabled />
      <div id="statusEdit" class="status"></div>
    </div>
    <div class="dlg-foot">
      <button id="btnDelete" style="display:none">刪除</button>
      <button id="btnCancelEdit">關閉</button>
      <button id="btnSaveEdit">儲存</button>
    </div>
  </dialog>

  <!-- 閱讀視窗 -->
  <dialog id="dlgRead">
    <div class="dlg-head">
      <span>閱讀</span>
      <div class="read-nav">
        <button id="btnPrev">上一則</button>
        <button id="btnNext">下一則</button>
      </div>
    </div>
    <div class="dlg-body">
      <div class="read-title" id="rTitle"></div>
      <div class="read-meta" id="rMeta"></div>
      <div class="read-content" id="rContent"></div>
      <div class="read-meta" id="rTags"></div>
    </div>
    <div class="dlg-foot">
      <button id="btnCloseRead">關閉</button>
      <button id="btnEditFromRead">編輯這則</button>
    </div>
  </dialog>

  <div id="toast" class="toast">已完成</div>

  <script>
  // ====== 常數（GAS 規則） ======
  const API = "https://script.google.com/macros/s/AKfycbx3oTDF49EmwGp5ZgGs9WIO64m7UzVzj5IDcBmm222aR7eTQTG8DXUsYVGVnzH2ga4abQ/exec";
  const ACT = { list:'列出筆記', get:'取得筆記', create:'新增筆記', update:'修改筆記', delete:'刪除筆記' };
  const KEY = { title:'標題', content:'內容', category:'分類', tags:'標籤', date:'日期', id:'id' };

  // ====== 點擊波紋（所有按鈕） ======
  document.body.addEventListener('click', e=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const r = document.createElement('span');
    r.className = 'ripple';
    const rect = btn.getBoundingClientRect();
    r.style.left = (e.clientX - rect.left) + 'px';
    r.style.top  = (e.clientY - rect.top) + 'px';
    btn.appendChild(r);
    setTimeout(()=> r.remove(), 500);
  });

  // ====== 工具 ======
  function clearErr(){ error.textContent=''; }
  function showErr(msg, raw){ error.textContent = '⚠️ ' + msg + (raw ? ('\n' + raw) : ''); }
  function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg||'已完成'; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), 1200); }
  function setStatus(el, msg, ok=false, err=false){ el.textContent=msg||''; el.classList.toggle('ok', !!ok); el.classList.toggle('err', !!err); }
  function normalizeList(data) {
    if (Array.isArray(data)) return data;
    if (!data || typeof data !== 'object') return [];
    return data.items || data.data || data.list || data.records || data.rows || data.notes || data.data || [];
  }
  function normalizeItem(d) { if (!d) return d; if (d.item) return d.item; if (d.data && !Array.isArray(d.data)) return d.data; return d; }
  function anyId(obj){
    if (!obj || typeof obj!=='object') return undefined;
    for (const k of Object.keys(obj)) {
      const low = k.toLowerCase();
      if (low==='id' || low.endsWith('id')) return obj[k];
      if (/筆記.*id/i.test(k) || /note.*id/i.test(k)) return obj[k];
    }
    return obj[KEY.id] ?? obj.id;
  }
  function fmtDate(s) {
    try { const d = new Date(s); if (!isNaN(d.getTime())) return d.toLocaleString('zh-TW', {hour12:false}); return s||''; }
    catch(e){ return s||''; }
  }
  function nowTaipeiStr() {
    try {
      const fmt = new Intl.DateTimeFormat('zh-TW', { timeZone:'Asia/Taipei', hour12:false,
        year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'
      }).format(new Date());
      const m = fmt.match(/(\d{4})[\/年\-](\d{2})[\/月\-](\d{2}).(\d{2}):(\d{2}):(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]} ${m[4]}:${m[5]}:${m[6]}`;
    } catch(e){}
    const d = new Date();
    const y = d.getUTCFullYear(), mm=String(d.getUTCMonth()+1).padStart(2,'0'), dd=String(d.getUTCDate()).padStart(2,'0');
    const hh=String((d.getUTCHours()+8)%24).padStart(2,'0'), mi=String(d.getUTCMinutes()).padStart(2,'0'), ss=String(d.getUTCSeconds()).padStart(2,'0');
    return `${y}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }
  function parseOne(text) {
    const tags = Array.from(text.matchAll(/#([^\s#]+)/g)).map(m=>m[1]);
    let 標題='', 分類='';
    const lines = text.split(/\r?\n/);
    const rest = [];
    for (let line of lines) {
      if (!標題) { const m = line.match(/^\s*標題\s*[：:]\s*(.+)$/); if (m) { 標題 = m[1].trim(); continue; } }
      if (!分類) { const m = line.match(/^\s*分類\s*[：:]\s*(.+)$/); if (m) { 分類 = m[1].trim(); continue; } }
      const cleaned = line.replace(/#([^\s#]+)/g, '').trimEnd();
      rest.push(cleaned);
    }
    let 內容 = rest.join('\n').trim();
    if (!標題) 標題 = (內容 || '（無標題）').slice(0, 8);
    const 標籤 = tags.join(',');
    return { 標題, 分類, 標籤, 內容 };
  }
  async function getJson(params){
    clearErr();
    const url = new URL(API);
    Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method:'GET' });
    const raw = await res.text();
    try { return JSON.parse(raw); } catch(e){ showErr('後端不是 JSON：', raw); return {error:'not_json', raw}; }
  }
  async function postJson(action, bodyObj){
    clearErr();
    const url = new URL(API);
    url.searchParams.set('action', action);
    const res = await fetch(url.toString(), {
      method:'POST',
      headers:{ 'Content-Type':'application/json;charset=UTF-8' },
      body: JSON.stringify(bodyObj||{})
    });
    const raw = await res.text();
    try { return JSON.parse(raw); } catch(e){ showErr('後端不是 JSON：', raw); return {error:'not_json', raw}; }
  }

  // ====== 主清單 ======
  let notes = [];
  let editingId = null;
  let currentIndex = -1;
  let autoTimer = null;

  async function loadList(keyword='') {
    const data = await getJson({ action: ACT.list, keyword, q: keyword, limit: 200 });
    notes = normalizeList(data);
    renderList();
  }
  function renderList() {
    const el = document.getElementById('list');
    el.innerHTML = '';
    const count = notes.length || 0;
    document.getElementById('count').textContent = count + ' 筆';
    if (!count) { el.innerHTML = '<div class="empty">沒有資料</div>'; return; }
    notes.forEach((n, idx)=> {
      const title = n[KEY.title] ?? n.title ?? '(無標題)';
      const date  = fmtDate(n[KEY.date] ?? n.date ?? '');
      const cat   = n[KEY.category] ?? n.category ?? '';
      const tags  = n[KEY.tags] ?? n.tags ?? '';
      const id    = anyId(n);
      const card = document.createElement('div');
      card.className = 'note';
      card.innerHTML = `
        <div class="note-body" data-open="${idx}">
          <div class="title">${title}</div>
          <div class="meta">${date}${cat?' · '+cat:''}${tags?' · '+tags:''}</div>
        </div>
        <div class="actions">
          <button data-id="${id ?? ''}" class="edit">編輯</button>
          <button data-id="${id ?? ''}" class="del">刪除</button>
        </div>`;
      el.appendChild(card);
    });
  }

  // ====== 點卡片 / 編輯 / 刪除 ======
  list.addEventListener('click', async (e)=> {
    const open = e.target.closest('[data-open]');
    const btn = e.target.closest('button');
    if (open) { openRead(parseInt(open.getAttribute('data-open'), 10)); return; }
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    if (!id) { showErr('找不到這筆的識別碼（id）'); return; }
    if (btn.classList.contains('edit')) {
      const d = await getJson({ action: ACT.get, id });
      const item = normalizeItem(d) || {}; if (anyId(item) == null) item.id = id;
      openEditor(item);
    } else if (btn.classList.contains('del')) {
      if (!confirm('確定要刪除？（將搬到回收）')) return;
      await postJson(ACT.delete, { id });
      toast('已刪除');
      await loadList(q.value.trim());
    }
  });

  // ====== 閱讀視窗 ======
  const dlgRead = document.getElementById('dlgRead');
  function openRead(idx) {
    currentIndex = idx;
    const n = notes[idx]; if (!n) return;
    rTitle.textContent = n[KEY.title] ?? n.title ?? '(無標題)';
    rMeta.textContent = [fmtDate(n[KEY.date] ?? n.date ?? ''), (n[KEY.category] ?? n.category ?? '')].filter(Boolean).join(' · ');
    rContent.textContent = (n[KEY.content] ?? n.content ?? '');
    rTags.textContent = (n[KEY.tags] ?? n.tags ?? '') ? '標籤：' + (n[KEY.tags] ?? n.tags ?? '') : '';
    dlgRead.showModal();
  }
  btnPrev.addEventListener('click', ()=> { if (currentIndex>0) openRead(currentIndex-1); });
  btnNext.addEventListener('click', ()=> { if (currentIndex<notes.length-1) openRead(currentIndex+1); });
  btnCloseRead.addEventListener('click', ()=> dlgRead.close());
  btnEditFromRead.addEventListener('click', async ()=> {
    const n = notes[currentIndex]; if (!n) return;
    const id = anyId(n);
    const d = await getJson({ action: ACT.get, id });
    const item = normalizeItem(d) || {}; if (anyId(item) == null) item.id = id;
    dlgRead.close();
    openEditor(item);
  });

  // ====== 搜尋、更新 ======
  btnRefresh.addEventListener('click', ()=> loadList(q.value.trim()));
  q.addEventListener('keydown', e=> { if (e.key==='Enter') btnSearch.click(); });
  btnSearch.addEventListener('click', ()=> loadList(q.value.trim()));
  btnClear.addEventListener('click', ()=> { q.value=''; loadList(''); });

  // ====== 新增（單框） ======
  const dlgNew = document.getElementById('dlgNew');
  btnNew.addEventListener('click', ()=> { fOne.value=''; setStatus(statusNew,''); dlgNew.showModal(); });
  btnCancelNew.addEventListener('click', ()=> { dlgNew.close(); fOne.value=''; setStatus(statusNew,''); }); // 關閉清空
  btnSaveNew.addEventListener('click', async ()=> {
    const t = fOne.value.trim();
    if (!t) { setStatus(statusNew,'請輸入內容',false,true); return; }
    const data = parseOne(t);
    if (!data.標題) { setStatus(statusNew,'請加入「標題：」或至少一些內容',false,true); return; }
    const payload = { '日期': nowTaipeiStr(), '分類': data.分類||'', '標籤': data.標籤||'', '標題': data.標題||'', '內容': data.內容||'' };
    await postJson(ACT.create, payload);
    setStatus(statusNew, '已儲存', true, false);
    toast('已儲存');
    await loadList(q.value.trim()); // 不關視窗
  });

  // ====== 編輯 ======
  const dlgEdit = document.getElementById('dlgEdit');
  function openEditor(item=null) {
    editingId = anyId(item) ?? null;
    document.getElementById('dlgTitle').textContent = editingId ? '編輯筆記' : '新增筆記';
    fTitle.value    = item?.[KEY.title]    ?? item?.title   ?? '';
    fContent.value  = item?.[KEY.content]  ?? item?.content ?? '';
    fCategory.value = item?.[KEY.category] ?? item?.category?? '';
    fTags.value     = item?.[KEY.tags]     ?? item?.tags    ?? '';
    fDate.value     = fmtDate(item?.[KEY.date] ?? item?.date ?? '');
    setStatus(statusEdit, '');
    btnDelete.style.display = editingId ? '' : 'none';
    dlgEdit.showModal();
  }
  btnCancelEdit.addEventListener('click', ()=> { dlgEdit.close(); fTitle.value=''; fContent.value=''; fCategory.value=''; fTags.value=''; fDate.value=''; setStatus(statusEdit,''); editingId=null; }); // 關閉清空
  btnSaveEdit.addEventListener('click', async ()=> {
    const title = fTitle.value.trim();
    if (!title) { setStatus(statusEdit,'請填標題',false,true); return; }
    if (!editingId) { setStatus(statusEdit,'缺少 id，無法修改',false,true); return; }
    const body = { id: editingId, '標題': title, '內容': fContent.value.trim(), '分類': fCategory.value.trim(), '標籤': fTags.value.trim() };
    await postJson(ACT.update, body);
    setStatus(statusEdit, '已儲存', true, false);
    toast('已儲存');
    await loadList(q.value.trim()); // 不關視窗
  });
  btnDelete.addEventListener('click', async ()=> {
    if (!editingId) { setStatus(statusEdit,'缺少 id，無法刪除',false,true); return; }
    if (!confirm('確定要刪除？（將搬到回收）')) return;
    await postJson(ACT.delete, { id: editingId });
    toast('已刪除');
    dlgEdit.close();
    fTitle.value=''; fContent.value=''; fCategory.value=''; fTags.value=''; fDate.value=''; setStatus(statusEdit,''); editingId=null;
    await loadList(q.value.trim());
  });

  // ====== 自動刷新（每 15 秒） ======
  function startAuto() {
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = setInterval(()=> loadList(q.value.trim()), 15000);
  }

  // ====== 手勢：右滑返回、關雙擊/捏合 ======
  let startX=0, startY=0, moved=false, lastTouchEnd=0;
  window.addEventListener('touchstart', (e)=> { const t=e.touches[0]; startX=t.clientX; startY=t.clientY; moved=false; }, {passive:true});
  window.addEventListener('touchmove', ()=> { moved=true; }, {passive:true});
  window.addEventListener('touchend', (e)=> {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) { e.preventDefault(); }
    lastTouchEnd = now;
    if (!moved) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = Math.abs(t.clientY - startY);
    if (dx > 80 && dy < 50 && startX < 80) history.back();
  }, {passive:false});
  window.addEventListener('gesturestart', e=> { e.preventDefault(); }, {passive:false});

  // 啟動
  window.addEventListener('load', ()=> {
    if ('serviceWorker' in navigator) try { navigator.serviceWorker.register('./sw.js'); } catch(e){}
    loadList(''); startAuto();
  });
  </script>
</body>
</html>
