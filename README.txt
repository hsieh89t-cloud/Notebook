私人心情筆記｜PWA 與 Google 試算表架構指南
====================================

版本：v2.0.0
最後更新：2025-01-19

整體目標
--------
打造一個去 AI 味、可離線安裝的私人心情筆記。核心資料儲存在 Google 試算表，
透過 Google Apps Script (GAS) 提供 API，並搭配 PWA 介面（index.html）。
支援手機優先操作、右滑返回上一頁、黑白雙模式與留言互動。

Google 試算表結構
------------------
請建立同一份試算表內的三個分頁：

1. MoodJournal（主表，儲存筆記內容）
   - 記錄時間：字串或日期時間格式，預設為台北時間 ISO 字串。
   - 心情指數：1~5 的數字或文字標示（例如「3｜平穩」）。
   - 情緒主題：自由文字，例如「工作」、「家庭」、「自我對話」。
   - 標題：筆記標題。
   - 標籤：以逗號或井字號分隔的標籤字串。
   - 正文：完整心情記錄，支援換行。
   - 亮點摘錄：一句話摘要，方便在列表中快速瀏覽。
   - 配色：以 #RRGGBB 或預設關鍵字（calm / sunset / ocean）控制 PWA 卡片色塊。
   - ID：由系統自動生成的唯一識別碼。
   - 回收：核取方塊或布林，空值代表使用中；TRUE 代表已送至回收桶。

2. MoodRecycle（回收桶）
   - 欄位順序與 MoodJournal 完全一致。
   - 刪除時間：自動寫入搬移到回收桶的時間。
   - 永久刪除：核取方塊；勾選後可由工具腳本批次清除。

3. MoodComments（留言）
   - 留言ID：唯一識別碼（系統自動生成）。
   - 筆記ID：對應 MoodJournal 的 ID。
   - 留言時間：台北時間 ISO 字串。
   - 留言者：可留暱稱；預設為「Me」。
   - 留言內容：留言文字，支援換行。
   - 狀態：空字串為正常；填入 deleted 代表已移除。

GAS 專案分層
------------
1. Notebook_Core.gs（對應 repo 中的 `Code(GAS核心).txt`）
   - 提供 RESTful API：列出/取得/新增/修改/刪除筆記，列出/新增/修改/刪除留言，還原筆記。
   - 提供 iOS 捷徑端點 `捷徑寫入心情`（POST text）。
   - 回傳 JSON，全部時間使用 Asia/Taipei。

2. Notebook_Tools.gs（對應 `Notebook_工具包_v1.0.0.txt`）
   - 建立 Spreadsheet 自訂選單。
   - 一鍵健檢、批次清理回收桶、批次永久刪除留言、日期區間導出。
   - 工具端也遵守欄位順序，必要時自動補齊分頁與欄位。

PWA 功能摘要
------------
- 首頁卡片瀏覽：顯示心情指數色塊、亮點、標籤、時間。
- 卡片下方即時留言串：最新留言顯示在最下方，與 Facebook 一樣排列。
- 留言輸入框：高度 44px、圓角、支援貼圖鍵盤；按下 Enter 送出，Shift+Enter 換行。
- 主題切換：右上角太陽/月亮按鈕，在黑/白模式間切換，會記錄在 localStorage。
- 右滑返回上一頁：在左邊緣向右滑超過 60px 時觸發 `history.back()` 或關閉開啟中的對話框。
- 直覺操作：浮動＋按鈕新增心情；長按卡片呼叫編輯；刪除按鈕在編輯對話框內。
- RWD：寬螢幕改為雙欄排列，手機維持單欄。
- 支援離線：manifest.json 與 sw.js 提供離線快取，再搭配前端 localStorage 快速載入最後一次資料。
- 快取提示：離線時會自動顯示頂部提醒列、計數標示「快取」，並避免觸發遠端請求。
- 搜尋優化：輸入框支援即時過濾與 Enter 送出，維持使用者最後一次的篩選條件。
- 錯誤防護：離線狀態下禁止提交編輯、留言或刪除，立即提示使用者恢復網路後再試。

iOS 捷徑寫入
-------------
POST 到 Core API，action = `捷徑寫入心情`，body：
```
{
  "text": "心情指數：4\n情緒主題：通勤\n#通勤 #晨間\n今天看見日出很療癒"
}
```
核心會自動解析欄位、補齊時間與 ID。

部署提醒
--------
- 每次重新部署 GAS，請更新 index.html 內的 `const API`。
- 首次開啟 PWA 請允許「新增到主畫面」。
- 若有調整試算表欄位名稱，需同步調整 Core 程式的表頭常數。
- 行動裝置建議使用 Safari/Chrome（版本 16+）。

